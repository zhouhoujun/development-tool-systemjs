"use strict";var __extends=this&&this.__extends||function(e,n){function t(){this.constructor=e}for(var s in n)n.hasOwnProperty(s)&&(e[s]=n[s]);e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)},__decorate=this&&this.__decorate||function(e,n,t,s){var r,o=arguments.length,i=o<3?n:null===s?s=Object.getOwnPropertyDescriptor(n,t):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,n,t,s);else for(var l=e.length-1;l>=0;l--)(r=e[l])&&(i=(o<3?r(i):o>3?r(n,t,i):r(n,t))||i);return o>3&&i&&Object.defineProperty(n,t,i),i},__metadata=this&&this.__metadata||function(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)},_=require("lodash"),development_core_1=require("development-core"),path=require("path"),fs_1=require("fs"),chalk=require("chalk"),replace=require("gulp-replace"),Builder=require("systemjs-builder"),source=require("vinyl-source-stream"),vinylBuffer=require("vinyl-buffer"),chksum=require("checksum"),mkdirp=require("mkdirp"),SystemjsBundle=function(e){function n(n){var t=e.call(this,n)||this;return t.name="systemjs-bundle",t.runWay=development_core_1.RunWay.sequence,t.manifestSplit="/*------bundles infos------*/",t}return __extends(n,e),n.prototype.source=function(e,n,t){var s=this,r=e.option;return r.bundles?this.initBundles(e).then(function(){return Promise.all(_.map(s.getBundles(e),function(n){return s.loadBuilder(e).then(function(r){var o=s.bundleConfig[n],i=s.getBuildConfig(e);return o.builder=_.defaults(o.builder,i),o.builder.config&&r.config(o.builder.config),s.groupBundle(e,r,n,o,t).then(function(e){return s.translate(e)})})}))}).then(function(e){return _.flatten(e)}):this.loadBuilder(e).then(function(n){var t=e.getSrc(s.getInfo());console.log("start bundle all src : ",chalk.cyan(t));var r=s.getBuildConfig(e);return r.config&&n.config(r.config),e.fileFilter(t).then(function(t){t=s.getRelativeSrc(e,t),console.log("bundle files:",chalk.cyan(t));var o=s.getBundleManifestPath(e);return s.createBundler(e,n,"bundle",t.join(" + "),o,r).then(function(e){return s.translate(e)})})})},n.prototype.execute=function(n,t){var s=this;this.bundleMaps=[];var r=n;return e.prototype.execute.call(this,r,t).then(function(){var e=r.option;return e.bundles?s.calcChecksums(e,s.bundleMaps).then(function(e){return s.updateBundleManifest(r,s.bundleMaps,e)}):null}).then(function(e){return e?s.writeBundleManifest(r,e,t).then(function(){console.log(chalk.green("------ Complete -------------"))}):(console.log(chalk.green("------ Complete -------------")),null)})},n.prototype.setup=function(n,t){return n.option=this.initOption(n),e.prototype.setup.call(this,n,t)},n.prototype.pipes=function(n,t,s){var r=e.prototype.pipes.call(this,n,t,s)||[],o=this.getAssertResetPipe(n);return o&&o.length>0&&(r=r.concat(o)),r},n.prototype.working=function(n,t,s,r,o,i){var l=this,u=n.bundle;return e.prototype.working.call(this,n,t,s,r,o,i).then(function(){var e={path:u.path,modules:u.modules};l.bundleMaps.push(e),u.sfx?console.log("Built sfx package: "+chalk.cyan(u.bundleName)+" -> "+chalk.cyan(u.filename)+"\n   dest: "+chalk.cyan(u.bundleDest)):console.log("Bundled package: "+chalk.cyan(u.bundleName)+" -> "+chalk.cyan(u.filename)+"\n   dest: "+chalk.cyan(u.bundleDest))})},n.prototype.getOption=function(e){return e.option},n.prototype.loadBuilder=function(e){var n=e.option,t=new Builder(_.isArray(n.systemConfig)?_.first(n.systemConfig):n.systemConfig);return Promise.resolve(t).then(function(e){return _.isArray(n.systemConfig)&&n.systemConfig.length>1?Promise.all(n.systemConfig.map(function(n){return e.loadConfig(n,void 0,!0)})).then(function(){return e}):e})},n.prototype.translate=function(e){return _.isArray(e)?_.map(e,function(e){return e.stream.bundle=e.bundle,e.stream}):(e.stream.bundle=e.bundle,e.stream)},n.prototype.initBundles=function(e){var n=this,t=e.option,s=Promise.resolve(null).then(function(){return e.to(t.bundles)});return t.bundleDeps&&(s=s.then(function(n){var s=e.getPackage(t.packageFile);s||(console.log(chalk.red("can not found package.json file.")),process.exit(0));var r=t.dependencies?e.to(t.dependencies):_.keys(s.jspm.dependencies);if((!r||r.length<0)&&(console.log(chalk.red("not set bundle dependencies libs, or not setting jspm config.")),process.exit(0)),t.depsExclude){var o=_.isFunction(t.depsExclude)?t.depsExclude(e,r):t.depsExclude;r=_.filter(r,function(e){return o.indexOf(e)<0})}return Promise.resolve().then(function(){return _.isFunction(t.bundleDeps)?t.bundleDeps(e,r):_.isBoolean(t.bundleDeps)?{deplibs:{combine:!0,items:r}}:t.bundleDeps}).then(function(e){var t=_.keys(e);return _.each(_.keys(n),function(s){var r=n[s];r.exclude=r.exclude||[],r.exclude=t.concat(r.exclude),e[s]=r}),e})})),s.then(function(e){return n.bundleConfig=e,console.log("group bundles setting:\n",e,"---------------------------------\n"),e})},n.prototype.getRelativeSrc=function(e,n,t){var s=this;void 0===t&&(t=!1);var r=e.option.bundleBaseDir;if(_.isArray(n))return _.map(n,function(n){var o=e.toUrl(r,n);return t?s.toModulePath(o):o});var o=e.toUrl(r,n);return[t?this.toModulePath(o):o]},n.prototype.toModulePath=function(e){return e?e.substring(0,e.length-path.extname(e).length):""},n.prototype.initOption=function(e){var n=_.extend({baseURL:"",bundleBaseDir:".",mainfile:"bundle.js",systemConfig:"",packageFile:"package.json",dest:"",file:"",systemConfigTempl:"",relationToRoot:"",bust:"",bundles:null,bundlePaths:function(e){var t={},s=e.getDist(),r=n.bundleBaseDir;return e.getFolders(r,function(n,o){if(n!==s){var i=o+"/*";t[i]=e.toUrl(e.env.root,path.join(r,i))}return""}),console.log("paths: ",t),t},includePackageFiles:["node_modules/systemjs/dist/system-polyfills.src.js","node_modules/systemjs/dist/system.src.js"],jspmMates:{"*.css":{loader:"css"},"*.json":{loader:"json"},"*.jsx":{loader:"jsx"}},builder:{sfx:!1,minify:!1,mangle:!1,sourceMaps:!1,separateCSS:!1,lowResSourceMaps:!0}},e.option);return e.option=n,n.baseURL=e.toRootPath(e.toStr(n.baseURL)),!n.bundleBaseDir&&e.parent?n.bundleBaseDir=e.parent.getDist():n.bundleBaseDir?n.bundleBaseDir=e.toRootPath(e.toStr(n.bundleBaseDir)):(console.log(chalk.red("bundleBaseURL config error!")),process.exit(0)),n.includes=n.includes||[],(n.includePackageFiles||[]).forEach(function(t){n.includes.push(e.toRootPath(t))}),n.systemConfig&&(n.systemConfig=e.toRootSrc(e.toSrc(n.systemConfig))),n.packageFile=e.toRootPath(e.toStr(n.packageFile)),n.mainfile=e.toStr(n.mainfile),n},n.prototype.getBuildConfig=function(e){var n=e.option;return n.builder.config||(n.builder.config=_.extend(n.builder.config||{},{paths:e.to(n.bundlePaths)||{},rootURL:n.bundleBaseDir})),n.builder},n.prototype.getAssertResetPipe=function(e){if(!this.restps){var n=e.option;if(_.isUndefined(n.resetAsserts)&&(n.resetAsserts="assets"),n.resetAsserts){var t=void 0;if(_.isString(n.resetAsserts)){var s=e.toDistPath(n.resetAsserts,this.getInfo());fs_1.existsSync(s)?(t=e.getFolders(s),t.push(s)):console.log(chalk.yellow("rest css asserts folders:",s,"not exists."))}else t=e.toDistSrc(n.resetAsserts,this.getInfo());t=t||[];var r=[],o=e.getDist(this.getInfo()),i=n.baseURL,l=e.getRootPath();_.each(t,function(n){var t=e.toUrl(l,path.join(i,e.toUrl(o,n))),s=path.basename(n);console.log("reset css url folder name:",chalk.cyan(s),"relate url:",chalk.cyan(t));var u=new RegExp("(url\\((..\\/)+"+s+")|(url\\(\\/"+s+")","gi");r.push(function(){return replace(u,"url("+t)});var a=new RegExp("(url\\(\\'(..\\/)+"+s+")|(url\\(\\'\\/"+s+")","gi");r.push(function(){return replace(a,"url(\\'"+t)});var c=new RegExp('(url\\(("..\\/)+'+s+')|(url\\("\\/'+s+")","gi");r.push(function(){return replace(c,'url("'+t)})}),this.restps=r}else this.restps=[]}return this.restps},n.prototype.getBundles=function(e){var n=this,t=[];return e.env.gb&&(t=_.uniq(_.isArray(e.env.gb)?e.env.gb:(e.env.gb||"").split(","))),t=t.length<1?_.keys(this.bundleConfig):_.filter(t,function(e){return e&&n.bundleConfig[e]}),console.log("cmmand group bundle:",chalk.cyan(t)),t},n.prototype.groupBundle=function(e,n,t,s,r){var o=this,i="",l="",u=[],a=this.exclusionString(s.exclude,this.bundleConfig);return s.items&&(u=_.isArray(u)?s.items:_.keys(s.items)),s.combine?(l=this.getBundleDest(e,t,s),i=u.join(" + ")+a,console.log("Bundling group: "+chalk.cyan(t)+" ... \ngroup source:\n  "+chalk.cyan(i)+"\n-------------------------------"),this.createBundler(e,n,t,i,l,s.builder,s)):(console.log("Bundling group: "+chalk.cyan(t)+" ... \ngroup items:\n  "+chalk.cyan(u)+"\n-------------------------------"),Promise.all(u.map(function(t){return i=t+a,l=o.getBundleDest(e,t,s),o.createBundler(e,n,t,i,l,s.builder,s)})))},n.prototype.exclusionString=function(e,n){var t=this.exclusionArray(e,n).join(" - ");return t?" - "+t:""},n.prototype.exclusionArray=function(e,n){var t=this,s=[];return e=_.isArray(e)?e:_.keys(e),_.forEach(e,function(e){var r=n[e];r?s=s.concat(t.exclusionArray(r.items,n)):s.push(e)}),s},n.prototype.createBundler=function(e,n,t,s,r,o,i){var l=o.sfx,u=l?n.buildStatic:n.bundle,a=this.getBundleShortPath(e,t,i),c=path.parse(r).base,p=_.extend({outFile:r},o||{});return"normalize"in p||(p.normalize=!0),"lowResSourceMaps"in p||(p.lowResSourceMaps=!0),u.bind(n)(s,p).then(function(e){mkdirp.sync(path.dirname(r));var n=source(c);return n.write(e.source),process.nextTick(function(){n.end()}),console.log("pipe bundling：",chalk.cyan(e.source)),console.log("pipe bundling：",chalk.cyan(e.modules)),console.log("pipe bundling：",chalk.cyan(t)),{stream:n.pipe(vinylBuffer()),bundle:{path:a,sfx:l,bundleName:t,filename:c,bundleDest:r,modules:e.modules}}})},n.prototype.calcChecksums=function(e,n){var t={};return console.log("Calculating checksums..."),Promise.all(_.map(n,function(n){return _.isObject(n)?new Promise(function(s,r){var o=path.join(e.bundleBaseDir||".",n.path),i=path.parse(n.path).base;chksum.file(o,function(e,r){e&&console.error(chalk.red(" Checksum Error:"),chalk.red(e)),console.log(i,chalk.cyan(r)),t[n.path]=r,s(t)})}):null})).then(function(){return t})},n.prototype.updateBundleManifest=function(e,n,t){t=t||{};var s=_.defaults(this.getBundleManifest(e),{bundles:{},chksums:{}});return _.each(n,function(e){e.path&&(s.bundles[e.path]=e.modules,s.chksums[e.path]=t[e.path]||"")}),s},n.prototype.writeBundleManifest=function(n,t,s){var r=this,o=n.option;if(!o.mainfile)return Promise.reject("mainfile not configed.");console.log("Writing manifest...");var i=n.toUrl(n.getRootPath(),o.baseURL)||".";console.log("system config baseURL: ",chalk.cyan(i));var l=n.toStr(o.bust);console.log("system bust: ",chalk.cyan(l));var u="\nSystem.config({\n    baseURL: '"+i+"',\n    defaultJSExtensions: true\n});\nSystem.bundled = true;\nSystem.bust = '"+l+"';\nif(window != undefined) window.prod = true;\n"+this.manifestSplit+"\n",a="";if(t){a=n.toStr(o.systemConfigTempl),a||(a=l?"\n(function(module) {\n    var bust = {};\n    var systemLocate = System.locate;\n    var systemNormalize = System.normalize;\n    var paths =  module.exports.paths = ${paths} || {};\n    var chksums = module.exports.chksums = ${chksums};\n    var bundles = module.exports.bundles = ${bundles};                    \n    var maps = ${ maps };\n    var jspmMeta = ${ jspmMeta };\n\n    System.config({\n            packages: {\n            \"meta\": jspmMeta\n        },\n        map: maps,\n        paths: paths,\n        bundles: bundles\n    });\n\n    System.normalize = function (name, pName, pAddress) {\n        return systemNormalize.call(this, name, pName, pAddress).then(function (address) {\n            var chksum = chksums[name];\n            if (chksums[name]) { bust[address] = chksum; }\n            return address;\n        });\n    };\n\n    System.locate = function (load) {\n        return Promise.resolve(systemLocate.call(this, load)).then(function (address) {\n            var chksum = bust[address];\n            return (chksum) ? address + '?' + chksum : address;\n        });\n    };\n\n})((typeof module !== 'undefined') ? module : {exports: {}}, this);\n":"\n(function(module) {\n    var bundles = module.exports.bundles = ${bundles};\n    var paths =  module.exports.paths = ${paths} || {};\n    var maps = ${ maps };\n    var jspmMeta = ${ jspmMeta };\n\n    System.config({\n            packages: {\n            \"meta\": jspmMeta\n        },\n        map: maps,\n        paths: paths,\n        bundles: bundles\n    });\n\n})((typeof module !== 'undefined') ? module : {exports: {}}, this);\n");var c={css:"github:systemjs/plugin-css@0.1.20.js",json:"github:systemjs/plugin-json@0.1.2.js"};_.each(_.keys(t.bundles),function(e){/css.min.js$/.test(e)&&(c.css=_.first(t.bundles[e])),/json.min.js$/.test(e)&&(c.css=_.first(t.bundles[e]))});var p=o.jspmMates;u+=_.template(a)({maps:JSON.stringify(c,null,"    "),jspmMeta:JSON.stringify(p,null,"    "),paths:JSON.stringify(null,null,"    "),chksums:JSON.stringify(t.chksums,null,"    "),bundles:JSON.stringify(t.bundles,null,"    ")})}var d=o.includes||[];return Promise.all(_.map(d,function(e){return new Promise(function(n,t){fs_1.readFile(e,"utf8",function(e,s){e?t(e):n(s)})})})).then(function(t){t.push(u);var i=n.toStr(o.mainfile);console.log("mainfile:",i),mkdirp.sync(path.dirname(i));var l=source(i);return l.write(t.join("\n")),process.nextTick(function(){l.end()}),e.prototype.working.call(r,l.pipe(vinylBuffer()),n,o,s,o.mainfilePipes||[],o.mainfileOutput)})},n.prototype.getBundleManifestPath=function(e){return this.getBundleDest(e,e.option.mainfile)},n.prototype.getBundleManifest=function(e){var n={},t=this.getBundleManifestPath(e);if(console.log("try to load old bundle in path ",t),fs_1.existsSync(t))try{var s=fs_1.readFileSync(t,"utf8"),r=s.indexOf(this.manifestSplit);r=r>0?r+this.manifestSplit.length:0,s=s.substring(r),fs_1.writeFileSync(t,s),n=require(t),console.log("has old bundle：\n",chalk.cyan(t))}catch(e){console.log(chalk.red(e))}else console.log("no old bundle：\n",chalk.cyan(t));return n},n.prototype.getBundleShortPath=function(e,n,t){var s=t?this.getBundleDest(e,n,t):path.join(e.getDist(),n);return e.toUrl(e.option.bundleBaseDir,s)},n.prototype.getBundleDest=function(e,n,t){var s=e.getDist();if(t){var r=t.builder.minify,o=t.items[n]||n,i=o+(r?".min.js":".js");s=t.combine?path.join(s,i):path.join(s,n,i)}else s=path.join(s,n);return s},n}(development_core_1.PipeTask);SystemjsBundle=__decorate([development_core_1.task({oper:development_core_1.Operation.release|development_core_1.Operation.deploy}),__metadata("design:paramtypes",[Object])],SystemjsBundle),exports.SystemjsBundle=SystemjsBundle;
//# sourceMappingURL=sourcemaps/SystemjsBundle.js.map
